<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Финансы</title>

<style>
:root{
  --bg:#f5f5f2;
  --card:#fbfbf8;
  --border:#e3e3de;
  --text-main:#141414;
  --text-muted:#6b6b6b;
  --green:#2f8f5f;
  --red:#a14a4a;
}
*{box-sizing:border-box}

body{
  margin:0;
  background:var(--bg);
  font-family:Helvetica,Arial,sans-serif;
  display:flex;
  justify-content:center;
  color:var(--text-main);
}

.page{
  width:100%;
  max-width:420px;
  padding:16px;
  padding-bottom:180px;
  display:flex;
  flex-direction:column;
  gap:24px;
}

.section{
  background:var(--card);
  border:1px solid var(--border);
  padding:16px;
}

.title{
  font-size:10px;
  letter-spacing:2px;
  text-transform:uppercase;
  color:var(--text-muted);
  margin-bottom:10px;
}
.title span{
  cursor:pointer;
  text-decoration:underline;
}

/* GRAPH */
svg{width:100%;height:180px}

/* INTERPRETATION */
.interpretation{
  margin-top:12px;
  font-size:13px;
  line-height:1.4;
}
.quote{font-style:italic}
.author{
  font-size:11px;
  color:var(--text-muted);
  margin-bottom:6px;
}

/* STATS */
.stat-main{
  font-size:22px;
  font-weight:bold;
}
.stat-caption{
  font-size:10px;
  letter-spacing:2px;
  text-transform:uppercase;
  color:var(--text-muted);
  margin-top:6px;
}
.stat-sub{
  font-size:12px;
  margin-top:4px;
}
.stats{
  display:flex;
  justify-content:space-between;
  margin-top:12px;
}
.stat-value{font-size:16px}
.stat-label{
  font-size:10px;
  color:var(--text-muted);
  margin-top:4px;
}
.positive{color:var(--green)}
.negative{color:var(--red)}

/* FORM */
.form{
  display:flex;
  flex-direction:column;
  gap:12px;
}
input,select,button{
  padding:12px;
  border-radius:8px;
  border:1px solid var(--border);
  background:var(--bg);
  color:var(--text-main);
}
button{cursor:pointer}

/* remove number arrows */
input[type=number]{
  -moz-appearance:textfield;
}
input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button{
  -webkit-appearance:none;
  margin:0;
}

/* FLOW */
.flow-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:pointer;
}
.flow-toggle{
  font-size:14px;
  color:var(--text-muted);
}
.flow-list{margin-top:8px}

.flow-day{margin-top:14px}
.flow-date{
  font-size:11px;
  letter-spacing:1.5px;
  text-transform:uppercase;
  color:var(--text-muted);
  margin-bottom:6px;
}
.flow-item{
  display:flex;
  justify-content:space-between;
  padding:6px 0;
  font-size:14px;
}
.flow-total{
  font-weight:bold;
  margin-top:4px;
}

/* DATE PICKER */
.date-picker{
  display:none;
  margin-top:8px;
}

/* PALETTE */
.palette{
  position:fixed;
  bottom:24px;
  left:50%;
  transform:translateX(-50%);
  display:flex;
  gap:12px;
}
.color-btn{
  width:34px;
  height:34px;
  border-radius:50%;
  border:none;
  cursor:pointer;
  box-shadow:0 6px 16px rgba(0,0,0,0.25);
}
/* HEADER */
.header{
  margin-bottom:16px;
}

.back-btn{
  background:none;
  border:none;
  padding:0;
  font-size:13px;
  color:var(--text-muted);
  cursor:pointer;
}
.limits-btn{
  width:100%;
  padding:10px;
  margin-top:12px;
  background:none;
  border:1px dashed var(--border);
  border-radius:10px;
  font-size:13px;
  color:var(--text-muted);
  cursor:pointer;
}
/* MODAL */
.modal-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.25);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:100;
}

.modal-card{
  width:94%;
  max-width:420px;
  background:var(--card);
  border:1px solid var(--border);
  border-radius:18px;
  padding:18px;
  box-shadow:0 20px 60px rgba(0,0,0,0.25);
}

.modal-title{
  font-size:11px;
  letter-spacing:2px;
  text-transform:uppercase;
  color:var(--text-muted);
  margin-bottom:14px;
}

/* ADD */
.add-row{
  width:100%;
  padding:8px;
  background:none;
  border:1px dashed var(--border);
  border-radius:8px;
  font-size:13px;
  color:var(--text-muted);
  cursor:pointer;
  margin-bottom:14px;
}

/* ACTIONS */
.modal-actions{
  display:flex;
  gap:10px;
}

.modal-actions button{
  flex:1;
  padding:10px;
  border-radius:10px;
  border:1px solid var(--border);
  background:none;
  cursor:pointer;
}

.modal-actions .primary{
  border-color:var(--text-main);
  color:var(--text-main);
}

.modal-actions .secondary{
  color:var(--text-muted);
}

.limit-row{
  display:flex;
  align-items:center;
  gap:8px;
  margin-bottom:10px;
}

.limit-row input[type="checkbox"]{
  flex:0 0 16px;
}

.limit-row input[type="text"]{
  flex:2;
}

.limit-row input[type="number"]{
  flex:1;
}

.modal-card{
  overflow:hidden;
}

.limit-check{
  width:16px;
  height:16px;
  accent-color: var(--text-main);
  cursor:pointer;
}

.add-row.danger{
  color: var(--text-muted);
  border-style: solid;
}
</style>
</head>

<body>
<main class="page">

<!-- ПРОГРЕСС -->
<section class="section">
  <div class="title">
    Прогресс капитала · <span onclick="toggleDate()">месяц</span>
  </div>
  <div class="date-picker" id="datePicker">
    <input type="date" id="selectedDate">
  </div>

  <svg id="chart"></svg>

  <div class="interpretation" id="interpretation"></div>
</section>

<!-- ОБЩИЙ КАПИТАЛ -->
<section class="section">
  <div class="title">Цель</div>

  <div class="stat-main" id="capitalMain">—</div>
  <div class="stat-caption">Общий капитал</div>
  <div class="stat-sub" id="capitalDelta">—</div>

  <div class="stats">
    <div>
      <div class="stat-value" id="savedVal">—</div>
      <div class="stat-label">Сэкономлено</div>
    </div>
    <div>
      <div class="stat-value" id="incomeVal">—</div>
      <div class="stat-label">Отложено</div>
    </div>
    <div>
      <div class="stat-value" id="investedVal">—</div>
      <div class="stat-label">Инвестировано</div>
    </div>
  </div>
</section>

<!-- ДЕЙСТВИЕ -->
<section class="section">
  <div class="title">Зафиксировать действие</div>
  <form class="form" id="actionForm">
    <select id="kindSelect">
      <option value="save">Сэкономил</option>
      <option value="income">Отложил</option>
      <option value="invest">Инвестировал</option>
      <option value="expense">Расходовал</option>
      <option value="withdraw">Вывел</option>
    </select>
    <input id="amountInput" type="number" placeholder="Сумма (₽)" required>
    <button type="submit" id="submitBtn">Подтвердить</button>
  </form>
</section>

<!-- ===== ЛИМИТЫ НА МЕСЯЦ ===== -->
<section class="section">
  <div class="title" id="limitsTitle">Лимиты · месяц</div>
  <button class="limits-btn" onclick="openLimitsModal()">
    Управление лимитами
  </button>
</section>

<!-- ПОТОК -->
<section class="section">
  <div class="flow-header" onclick="toggleFlow()">
    <div class="title" style="margin:0" id="flowTitle">Поток капитала · 7 дней</div>
    <div class="flow-toggle" id="flowToggle">▾</div>
  </div>

  <div class="flow-list" id="flowList"></div>

  <!-- LIMITS MODAL -->
  <div class="modal-overlay" id="limitsModal">
    <div class="modal-card">
      <div class="modal-title">Лимиты · месяц</div>

      <div id="limitsRows"></div>

      <button class="add-row" onclick="addLimitRow()">+ Добавить категорию</button>
      <button class="add-row danger" onclick="removeSelectedLimits()">Удалить выбранные</button>

      <div class="modal-actions">
        <button class="secondary" onclick="closeLimitsModal()">Закрыть</button>
        <button class="primary" onclick="saveLimits()">Сохранить</button>
      </div>

    </div>
  </div>
</section>

</main>

<script>
/* ---------- helpers ---------- */
const fmtRub = (n) => {
  const sign = n < 0 ? "−" : "";
  const abs = Math.abs(Math.round(n));
  return sign + abs.toLocaleString("ru-RU") + " ₽";
};

const iso = (d) => d.toISOString().slice(0,10);
const daysAgo = (n) => new Date(Date.now() - n*86400000);

function monthNameRu(m){
  const names=["январь","февраль","март","апрель","май","июнь","июль","август","сентябрь","октябрь","ноябрь","декабрь"];
  return names[m-1] || "месяц";
}

function formatDateRu(isoDate){
  // isoDate: YYYY-MM-DD
  const [y,m,d]=isoDate.split("-").map(Number);
  const months=["января","февраля","марта","апреля","мая","июня","июля","августа","сентября","октября","ноября","декабря"];
  return `${d} ${months[m-1]}`;
}

/* ---------- DATE PICKER UI ---------- */
function toggleDate(){
  const d = document.getElementById("datePicker");
  d.style.display = d.style.display === "block" ? "none" : "block";
}

/* ---------- FLOW TOGGLE ---------- */
let flowOpen = true;
function toggleFlow(){
  const list = document.getElementById("flowList");
  const icon = document.getElementById("flowToggle");
  flowOpen = !flowOpen;
  list.style.display = flowOpen ? "block" : "none";
  icon.innerText = flowOpen ? "▾" : "▸";
}

/* ---------- API ---------- */
async function apiGet(url){
  const r = await fetch(url);
  if(!r.ok) throw new Error(`${r.status} ${await r.text()}`);
  return await r.json();
}

async function apiPost(url, body){
  const r = await fetch(url,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(body)
  });
  if(!r.ok) throw new Error(`${r.status} ${await r.text()}`);
  return await r.json();
}

/* ---------- LOAD: capital ---------- */
async function loadCapital(){
  const data = await apiGet("/api/finance/capital");
  const total = data.total || 0;

  const el = document.getElementById("capitalMain");
  el.textContent = fmtRub(total);
  el.className = "stat-main " + (total>=0 ? "positive":"negative");

  // "дельта" — прирост за последние 30 дней (по net из flow)
  const from = iso(daysAgo(30));
  const to = iso(new Date());
  const days = await apiGet(`/api/finance/flow?start=${from}&end=${to}`);
  const net30 = (days || []).reduce((a,d)=>a+(d.net||0),0);

  const deltaEl = document.getElementById("capitalDelta");
  deltaEl.textContent = (net30>=0?"+":"") + fmtRub(net30) + " к " + formatDateRu(to);
  deltaEl.className = "stat-sub " + (net30>=0 ? "positive":"negative");

  // агрегаты по kind за 30 дней
  let saved=0, invested=0, income=0;
  (days || []).forEach(d=>{
    (d.events||[]).forEach(e=>{
      if(e.kind==="save") saved += e.amount||0;
      if(e.kind==="invest") invested += e.amount||0;
      if(e.kind==="income") income += e.amount||0;
    });
  });

  document.getElementById("savedVal").textContent = fmtRub(saved);
  document.getElementById("savedVal").className = "stat-value " + (saved>=0 ? "positive":"negative");

  document.getElementById("incomeVal").textContent = fmtRub(income);
  document.getElementById("incomeVal").className = "stat-value " + (income>=0 ? "positive":"negative");

  document.getElementById("investedVal").textContent = fmtRub(invested);
  document.getElementById("investedVal").className = "stat-value " + (invested>=0 ? "positive":"negative");
}

/* ---------- LOAD: flow list (7 days) ---------- */
async function loadFlow(){
  const from = iso(daysAgo(7));
  const to = iso(new Date());
  const days = await apiGet(`/api/finance/flow?start=${from}&end=${to}`);

  const box = document.getElementById("flowList");
  box.innerHTML = "";

  // title month (из today)
  const now = new Date();
  document.getElementById("flowTitle").textContent = `Поток капитала · ${monthNameRu(now.getMonth()+1)}`;

  (days || []).forEach(d=>{
    const dayBlock = document.createElement("div");
    dayBlock.className = "flow-day";

    dayBlock.innerHTML = `<div class="flow-date">${formatDateRu(d.day)}</div>`;

    (d.events || []).forEach(e=>{
      const amount = e.amount || 0;
      const cls = amount>=0 ? "positive":"negative";
      const label = e.kind; // пока kind (категории будут позже)
      dayBlock.innerHTML += `
        <div class="flow-item">
          <span>${label}</span>
          <span class="${cls}">${fmtRub(amount)}</span>
        </div>`;
    });

    const net = d.net || 0;
    dayBlock.innerHTML += `
      <div class="flow-total ${net>=0?"positive":"negative"}">
        Итог дня: ${fmtRub(net)}
      </div>`;

    box.appendChild(dayBlock);
  });
}

/* ---------- LOAD: candle chart (30 days) ---------- */
async function loadChart(){
  const from = iso(daysAgo(30));
  const to = iso(new Date());
  const days = await apiGet(`/api/finance/flow?start=${from}&end=${to}`);

  // строим candles от net (капитал как линия)
  let base = 0;
  const candles = (days || []).slice().reverse().map(d=>{
    const o = base;
    const c = base + (d.net||0);
    const hi = Math.max(o,c);
    const lo = Math.min(o,c);
    base = c;
    return [o,hi,lo,c];
  });

  drawCandles(candles);

  // interpretation (без цитат пока, но реальная математика)
  const nets = (days||[]).map(d=>d.net||0);
  const today = nets.length ? nets[nets.length-1] : 0;
  const avg = nets.length ? nets.reduce((a,b)=>a+b,0)/nets.length : 0;

  document.getElementById("interpretation").innerHTML = `
    <div>Сегодня: <b class="${today>=0?"positive":"negative"}">${fmtRub(today)}</b></div>
    <div>В среднем: <b>${fmtRub(avg)}</b> в день</div>
    <div class="${today>=avg?"positive":"negative"}">
      ${today>=avg ? "Сегодняшний результат выше среднего" : "Сегодняшний темп ниже среднего"}
    </div>
  `;
}

function drawCandles(candles){
  const svg = document.getElementById("chart");
  svg.innerHTML = "";

  const w = svg.clientWidth, h = svg.clientHeight, p = 10;
  if(!candles.length){
    return;
  }
  const vals = candles.flat();
  const max = Math.max(...vals);
  const min = Math.min(...vals);
  const denom = (max - min) || 1;

  const sy = v => h - p - ((v - min) / denom) * (h - p * 2);
  const step = w / candles.length;
  const cw = step * 0.6;

  candles.forEach((c, i) => {
    const [o, hi, lo, cl] = c;
    const x = i * step + step / 2 - cw / 2;
    const color = cl >= o ? "var(--green)" : "var(--red)";

    const wick = document.createElementNS("http://www.w3.org/2000/svg", "line");
    wick.setAttribute("x1", x + cw / 2);
    wick.setAttribute("x2", x + cw / 2);
    wick.setAttribute("y1", sy(hi));
    wick.setAttribute("y2", sy(lo));
    wick.setAttribute("stroke", color);
    svg.appendChild(wick);

    const body = document.createElementNS("http://www.w3.org/2000/svg", "rect");
    body.setAttribute("x", x);
    body.setAttribute("width", cw);
    body.setAttribute("y", sy(Math.max(o, cl)));
    body.setAttribute("height", Math.max(1, Math.abs(sy(o) - sy(cl))));
    body.setAttribute("fill", color);
    svg.appendChild(body);
  });
}

/* ---------- FORM submit ---------- */
const form = document.getElementById("actionForm");
const btn = document.getElementById("submitBtn");

form.addEventListener("submit", async (e) => {
  e.preventDefault();

  const kind = document.getElementById("kindSelect").value;
  const amount = Number(document.getElementById("amountInput").value);

  if(!amount || amount<=0){
    alert("Введите сумму");
    return;
  }

  btn.innerText = "Сохраняем...";
  btn.disabled = true;

  try{
    await apiPost("/api/finance/events",{
      kind,
      amount,
      category_id: null,
      date: null
    });

    btn.innerText = "Зафиксировано";
    form.reset();

    // обновляем всё
    await Promise.all([loadCapital(), loadFlow(), loadChart()]);
  }catch(err){
    console.error(err);
    btn.innerText = "Ошибка";
    alert("Не удалось сохранить действие");
  }finally{
    setTimeout(()=>{
      btn.innerText = "Подтвердить";
      btn.disabled = false;
    }, 600);
  }
});

/* ---------- LIMITS MODAL ---------- */
function openLimitsModal(){
  document.getElementById("limitsModal").style.display = "flex";
  loadLimits().catch(console.error);
}

function closeLimitsModal(){
  document.getElementById("limitsModal").style.display = "none";
}

function addLimitRow(prefill){
  const row = document.createElement("div");
  row.className = "limit-row";

  row.innerHTML = `
    <input type="checkbox" class="limit-check">
    <input class="limit-category" type="text" placeholder="Категория" value="${prefill?.category ? escapeHtml(prefill.category) : ""}">
    <input class="limit-value" type="number" placeholder="Лимит ₽" value="${prefill?.monthly_limit ?? ""}">
  `;

  document.getElementById("limitsRows").appendChild(row);
}

function removeSelectedLimits(){
  const rows = document.querySelectorAll("#limitsRows .limit-row");
  rows.forEach(r=>{
    const cb = r.querySelector(".limit-check");
    if(cb && cb.checked) r.remove();
  });
}

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

async function loadLimits(){
  const now = new Date();
  const month = now.getMonth()+1;
  const year = now.getFullYear();

  document.getElementById("limitsTitle").textContent = `Лимиты · ${monthNameRu(month)}`;
  document.querySelector("#limitsModal .modal-title").textContent = `Лимиты · ${monthNameRu(month)}`;

  const box = document.getElementById("limitsRows");
  box.innerHTML = "";

  // Твой эндпоинт: GET /api/user/data?month=&year=
  // Вернёт список лимитов (как ты в сервисе делаешь)
  let data = [];
  try{
    data = await apiGet(`/api/user/data?month=${month}&year=${year}`);
  }catch(e){
    // если пока нет — это ок
    data = [];
  }

  if(!data.length){
    addLimitRow();
    return;
  }

  data.forEach(l=>{
    addLimitRow({
      category: l.category,
      monthly_limit: l.monthly_limit
    });
  });
}

async function saveLimits(){
  const now = new Date();
  const month = now.getMonth()+1;
  const year = now.getFullYear();

  const rows = document.querySelectorAll("#limitsRows .limit-row");

  // сохраняем каждую строку POST /api/limits
  // Твой LimitIn судя по коду принимает (user_id?, category, month, year, monthly_limit) — у тебя в limits.py user_id не берется из auth.
  // Поэтому здесь нужно user_id: 1 временно (как раньше), иначе бек не знает кого сохранять.
  // Если хочешь — сделаем limits роут безопасным через auth в следующем шаге.
  const user_id = 1;

  try{
    for(const r of rows){
      const category = r.querySelector(".limit-category")?.value?.trim();
      const monthly_limit = Number(r.querySelector(".limit-value")?.value);

      if(!category || !monthly_limit || monthly_limit<=0) continue;

      await apiPost("/api/limits",{
        user_id,
        category,
        month,
        year,
        monthly_limit
      });
    }

    closeLimitsModal();
  }catch(err){
    console.error(err);
    alert("Не удалось сохранить лимиты");
  }
}

/* ---------- INIT ---------- */
(async function init(){
  const now = new Date();
  const month = now.getMonth()+1;
  document.getElementById("limitsTitle").textContent = `Лимиты · ${monthNameRu(month)}`;

  await Promise.all([loadCapital(), loadFlow(), loadChart()]);
})();
</script>

</body>
</html>
